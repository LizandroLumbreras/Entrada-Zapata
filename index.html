<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Entradas – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs,
  addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTOS
const buscador = document.getElementById("buscador");
const tbody = document.getElementById("tbody");
const btnGuardar = document.getElementById("guardarEntrada");

let productosCache = [];
let tabla = [];

async function init() {
  await cargarProductos();
}
init();

////////////////////////////////////////////////////
// CARGAR PRODUCTOS CORREGIDO PARA TU COLECCIÓN
////////////////////////////////////////////////////
async function cargarProductos() {

  const q = query(collection(db, "productos"), where("activo", "==", true));
  const snap = await getDocs(q);

  productosCache = snap.docs.map(d => {
    const data = d.data();
    return {
      id: d.id,
      codigo: data.codigoBarra || d.id,
      descripcion: data.concepto || "",
      costo_sin_impuesto: Number(data.costoSinImpuesto || 0),
      equivalentes: data.codigosEquivalentes || []
    };
  });

  console.log("Productos cargados:", productosCache);
}

////////////////////////////////////////////////////
// BUSCADOR
////////////////////////////////////////////////////
buscador.addEventListener("input", () => {
  const t = buscador.value.trim().toLowerCase();
  if (!t) return;

  let p = productosCache.find(x =>
  x.codigo?.toLowerCase() === t ||
  x.equivalentes.map(e => e.toLowerCase()).includes(t)
);


  if (!p) {
    const lista = productosCache.filter(x =>
      x.descripcion?.toLowerCase().includes(t)
    );
    if (lista.length === 1) p = lista[0];
  }

  if (p) agregarProductoATabla(p);
});


////////////////////////////////////////////////////
// AGREGAR A LA TABLA
////////////////////////////////////////////////////
function agregarProductoATabla(p) {
  if (tabla.find(x => x.codigo === p.codigo)) return;

  tabla.push({
    codigo: p.codigo,
    descripcion: p.descripcion,
    costo: p.costo_sin_impuesto,
    cantidad: 0,
    linea: ""
  });

  renderTabla();
  buscador.value = "";
}

function renderTabla() {
  tbody.innerHTML = "";

  tabla.forEach((item, index) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${item.codigo}</td>
      <td>${item.descripcion}</td>
      <td><input type="number" min="0" value="${item.cantidad}" 
           onchange="tabla[${index}].cantidad = Number(this.value)">
      </td>
      <td><input type="text" value="${item.linea}" 
           onchange="tabla[${index}].linea = this.value">
      </td>
      <td>${item.costo.toFixed(2)}</td>
      <td><button onclick="eliminar(${index})">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

window.eliminar = function (i) {
  tabla.splice(i, 1);
  renderTabla();
};

////////////////////////////////////////////////////
// GUARDAR ENTRADA
////////////////////////////////////////////////////
btnGuardar.addEventListener("click", async () => {
  if (tabla.length === 0) {
    alert("No hay productos para guardar");
    return;
  }

  const entrada = {
    fecha: serverTimestamp(),
    productos: tabla.map(x => ({
      codigo: x.codigo,
      descripcion: x.descripcion,
      cantidad: x.cantidad,
      linea: x.linea,
      costo_sin_impuesto: x.costo
    }))
  };

  await addDoc(
    collection(db, "almacenes/almacen_zapata/entradas"),
    entrada
  );

  tabla = [];
  renderTabla();
  alert("Entrada registrada correctamente");
});
</script>


<style>
body {
  font-family: Arial;
  padding: 20px;
  background: #f4f4f4;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin-top: 20px;
}
th, td {
  padding: 10px;
  border: 1px solid #ccc;
  text-align: center;
}
th {
  background: #00416A;
  color: white;
}
input[type="number"], input[type="text"] {
  width: 100px;
}
button {
  padding: 6px 12px;
  background: #00416A;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
</style>

</head>
<body>

<h2>Entradas – Almacén Zapata</h2>

<input id="buscador" placeholder="Buscar producto por código o descripción"
       style="width:100%; padding:12px; font-size:16px;">

<table>
<thead>
<tr>
  <th>Código</th>
  <th>Descripción</th>
  <th>Cantidad</th>
  <th>Línea</th>
  <th>Costo sin IVA</th>
  <th>Eliminar</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button id="guardarEntrada">Guardar Entrada</button>

</body>
</html>
